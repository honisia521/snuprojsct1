import streamlit as st
import pandas as pd
from openai import OpenAI

# OpenAI API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

# --- ê²Œì„ ë°ì´í„° (ìƒ˜í”Œ) ---
games = {
    "ë¦¬ê·¸ ì˜¤ë¸Œ ë ˆì „ë“œ": {"ì¥ë¥´": "AOS", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.5, "ì„¤ëª…": "5ëŒ€5 íŒ€ ì „ëµ ê²Œì„. ë‹¤ì–‘í•œ ì±”í”¼ì–¸ê³¼ ì „ëµìœ¼ë¡œ ìŠ¹ë¦¬í•˜ì„¸ìš”."},
    "ë°°í‹€ê·¸ë¼ìš´ë“œ": {"ì¥ë¥´": "FPS", "ë‚œì´ë„": "ìƒ", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.0, "ì„¤ëª…": "ìµœí›„ì˜ 1ì¸ì´ ë  ë•Œê¹Œì§€ ì‹¸ìš°ëŠ” ë°°í‹€ë¡œì–„ ê²Œì„."},
    "ë§ˆì¸í¬ë˜í”„íŠ¸": {"ì¥ë¥´": "ìƒŒë“œë°•ìŠ¤", "ë‚œì´ë„": "í•˜", "í”Œë ˆì´ì–´ ìˆ˜": "ì‹±ê¸€/ë©€í‹°", "í‰ì ": 4.8, "ì„¤ëª…": "ë¸”ë¡ìœ¼ë¡œ ì´ë£¨ì–´ì§„ ì„¸ìƒì—ì„œ ììœ ë¡­ê²Œ íƒí—˜í•˜ê³  ê±´ì¶•í•˜ì„¸ìš”."},
    "ìŠ¤íƒ€í¬ë˜í”„íŠ¸ ë¦¬ë§ˆìŠ¤í„°": {"ì¥ë¥´": "RTS", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.2, "ì„¤ëª…": "ì „ì„¤ì ì¸ ì‹¤ì‹œê°„ ì „ëµ ê²Œì„. 3ê°€ì§€ ì¢…ì¡±ìœ¼ë¡œ ìš°ì£¼ë¥¼ ì§€ë°°í•˜ì„¸ìš”."},
    "ì–´ëª½ ì–´ìŠ¤": {"ì¥ë¥´": "ì¶”ë¦¬", "ë‚œì´ë„": "í•˜", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 3.9, "ì„¤ëª…": "ìš°ì£¼ì„  ì•ˆì˜ ì„í¬ìŠ¤í„°ë¥¼ ì°¾ì•„ë‚´ëŠ” ë§ˆí”¼ì•„ ê²Œì„."},
    "ì ¤ë‹¤ì˜ ì „ì„¤ ë¸Œë ˆìŠ¤ ì˜¤ë¸Œ ë” ì™€ì¼ë“œ": {"ì¥ë¥´": "ì•¡ì…˜ ì–´ë“œë²¤ì²˜", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ì‹±ê¸€", "í‰ì ": 4.9, "ì„¤ëª…": "ê´‘í™œí•œ í•˜ì´ë„ì„ íƒí—˜í•˜ë©° ë¯¸ìŠ¤í„°ë¦¬ë¥¼ í’€ì–´ê°€ëŠ” ì˜¤í”ˆì›”ë“œ ì–´ë“œë²¤ì²˜."},
    "ì—˜ë“  ë§": {"ì¥ë¥´": "ì•¡ì…˜ RPG", "ë‚œì´ë„": "ìµœìƒ", "í”Œë ˆì´ì–´ ìˆ˜": "ì‹±ê¸€/ë©€í‹°", "í‰ì ": 4.7, "ì„¤ëª…": "ê´‘í™œí•œ íŒíƒ€ì§€ ì„¸ê³„ì—ì„œ ê³ ë‚œì´ë„ì˜ ì•¡ì…˜ RPGë¥¼ ê²½í—˜í•˜ì„¸ìš”."},
    "ë¡œìŠ¤íŠ¸ì•„í¬": {"ì¥ë¥´": "MMORPG", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.4, "ì„¤ëª…": "ë°©ëŒ€í•œ ì„¸ê³„ê´€ê³¼ í™”ë ¤í•œ ì•¡ì…˜ì˜ MMORPG."},
    "ë°œë¡œë€íŠ¸": {"ì¥ë¥´": "FPS", "ë‚œì´ë„": "ìƒ", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.2, "ì„¤ëª…": "ì •êµí•œ ì´ê²©ì „ê³¼ ìš”ì› ìŠ¤í‚¬ì„ í™œìš©í•˜ëŠ” ì „ëµ FPS."},
    "ë””ì•„ë¸”ë¡œ 4": {"ì¥ë¥´": "ì•¡ì…˜ RPG", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ì‹±ê¸€/ë©€í‹°", "í‰ì ": 4.0, "ì„¤ëª…": "ì–´ë‘ìš´ íŒíƒ€ì§€ ì„¸ê³„ì—ì„œ ì•…ë§ˆë¥¼ ì‚¬ëƒ¥í•˜ëŠ” í•µì•¤ìŠ¬ë˜ì‹œ RPG."}
}
df_games = pd.DataFrame.from_dict(games, orient='index')
df_games.index.name = 'ê²Œì„ ì´ë¦„'

st.set_page_config(layout="wide", page_title="AI ê¸°ë°˜ ê²Œì„ ì¶”ì²œ (OpenAI)")

st.title("ğŸ® AI ê¸°ë°˜ ê²Œì„ ì¶”ì²œ (Powered by OpenAI)")

st.write("ì¢‹ì•„í•˜ëŠ” ê²Œì„ì´ë‚˜ ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì„ ì•Œë ¤ì£¼ì„¸ìš”. OpenAIê°€ ìƒˆ ê²Œì„ì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤!")

# --- ì‚¬ìš©ì ì…ë ¥ ë°©ì‹ ì„ íƒ ---
recommendation_type = st.radio(
    "ì¶”ì²œ ë°©ì‹ ì„ íƒ:",
    ("ì„ í˜¸ ê²Œì„ ì„ íƒ", "ììœ ë¡œìš´ í…ìŠ¤íŠ¸ ì„¤ëª…"),
    index=0
)

recommended_games_from_openai = ""

if recommendation_type == "ì„ í˜¸ ê²Œì„ ì„ íƒ":
    selected_game = st.selectbox(
        "ì¢‹ì•„í•˜ëŠ” ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”:",
        ['--ì„ íƒ--', *sorted(df_games.index.tolist())],
        key="openai_rec_game_select"
    )
    if selected_game != '--ì„ íƒ--':
        st.info(f"'{selected_game}'ì™€ ë¹„ìŠ·í•œ ê²Œì„ì„ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”!")
        if st.button("AI ì¶”ì²œë°›ê¸° (ì„ í˜¸ ê²Œì„)", key="btn_openai_game_rec"):
            with st.spinner("OpenAIê°€ ê²Œì„ì„ ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤..."):
                response = client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[
                        {"role": "system", "content": "ë„ˆëŠ” ìœ ëŠ¥í•œ ê²Œì„ íë ˆì´í„°ì•¼."},
                        {"role": "user", "content": f"'{selected_game}'ì™€ ë¹„ìŠ·í•œ ê²Œì„ 3ê°œë¥¼ ì¶”ì²œí•´ì¤˜. ê²Œì„ ì´ë¦„, ì¥ë¥´, ì„¤ëª…ì„ í•œêµ­ì–´ë¡œ."}
                    ],
                    max_tokens=500
                )
                recommended_games_from_openai = response.choices[0].message.content
            if recommended_games_from_openai:
                st.subheader("ğŸ’¡ OpenAI ì¶”ì²œ ê²°ê³¼")
                st.markdown(recommended_games_from_openai)

elif recommendation_type == "ììœ ë¡œìš´ í…ìŠ¤íŠ¸ ì„¤ëª…":
    user_description = st.text_area(
        "ì°¾ê³  ì‹¶ì€ ê²Œì„ ìŠ¤íƒ€ì¼ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”:",
        height=100,
        key="openai_rec_text_input"
    )
    if st.button("AI ì¶”ì²œë°›ê¸° (í…ìŠ¤íŠ¸ ì„¤ëª…)", key="btn_openai_text_rec"):
        if user_description:
            st.info(f"'{user_description}' ì„¤ëª…ì— ë§ëŠ” ê²Œì„ì„ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”!")
            with st.spinner("OpenAIê°€ ê²Œì„ì„ ì¶”ì²œ ì¤‘ì…ë‹ˆë‹¤..."):
                response = client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[
                        {"role": "system", "content": "ë„ˆëŠ” ìœ ëŠ¥í•œ ê²Œì„ íë ˆì´í„°ì•¼."},
                        {"role": "user", "content": f"'{user_description}'ì— ë§ëŠ” ê²Œì„ 3ê°œë¥¼ ì¶”ì²œí•´ì¤˜. ê²Œì„ ì´ë¦„, ì¥ë¥´, ì„¤ëª…ì„ í•œêµ­ì–´ë¡œ."}
                    ],
                    max_tokens=500
                )
                recommended_games_from_openai = response.choices[0].message.content
            if recommended_games_from_openai:
                st.subheader("ğŸ’¡ OpenAI ì¶”ì²œ ê²°ê³¼")
                st.markdown(recommended_games_from_openai)
        else:
            st.warning("ê²Œì„ ìŠ¤íƒ€ì¼ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”!")
