import streamlit as st
import pandas as pd
from openai import OpenAI
import time

# --- OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ---
api_key = st.secrets.get("OPENAI_API_KEY")
if not api_key:
    st.error("OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤! Streamlit Secrets í™•ì¸ í•„ìš”")
    st.stop()

client = OpenAI(api_key=api_key)

# --- ìƒ˜í”Œ ê²Œì„ ë°ì´í„° ---
games = {
    "ë¦¬ê·¸ ì˜¤ë¸Œ ë ˆì „ë“œ": {"ì¥ë¥´": "AOS", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.5, "ì„¤ëª…": "5ëŒ€5 íŒ€ ì „ëµ ê²Œì„. ë‹¤ì–‘í•œ ì±”í”¼ì–¸ê³¼ ì „ëµìœ¼ë¡œ ìŠ¹ë¦¬í•˜ì„¸ìš”."},
    "ë°°í‹€ê·¸ë¼ìš´ë“œ": {"ì¥ë¥´": "FPS", "ë‚œì´ë„": "ìƒ", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.0, "ì„¤ëª…": "ìµœí›„ì˜ 1ì¸ì´ ë  ë•Œê¹Œì§€ ì‹¸ìš°ëŠ” ë°°í‹€ë¡œì–„ ê²Œì„."},
    "ë§ˆì¸í¬ë˜í”„íŠ¸": {"ì¥ë¥´": "ìƒŒë“œë°•ìŠ¤", "ë‚œì´ë„": "í•˜", "í”Œë ˆì´ì–´ ìˆ˜": "ì‹±ê¸€/ë©€í‹°", "í‰ì ": 4.8, "ì„¤ëª…": "ë¸”ë¡ìœ¼ë¡œ ì´ë£¨ì–´ì§„ ì„¸ìƒì—ì„œ ììœ ë¡­ê²Œ íƒí—˜í•˜ê³  ê±´ì¶•í•˜ì„¸ìš”."},
    "ìŠ¤íƒ€í¬ë˜í”„íŠ¸ ë¦¬ë§ˆìŠ¤í„°": {"ì¥ë¥´": "RTS", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.2, "ì„¤ëª…": "ì „ì„¤ì ì¸ ì‹¤ì‹œê°„ ì „ëµ ê²Œì„. 3ê°€ì§€ ì¢…ì¡±ìœ¼ë¡œ ìš°ì£¼ë¥¼ ì§€ë°°í•˜ì„¸ìš”."},
    "ì–´ëª½ ì–´ìŠ¤": {"ì¥ë¥´": "ì¶”ë¦¬", "ë‚œì´ë„": "í•˜", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 3.9, "ì„¤ëª…": "ìš°ì£¼ì„  ì•ˆì˜ ì„í¬ìŠ¤í„°ë¥¼ ì°¾ì•„ë‚´ëŠ” ë§ˆí”¼ì•„ ê²Œì„."},
    "ì—˜ë“  ë§": {"ì¥ë¥´": "ì•¡ì…˜ RPG", "ë‚œì´ë„": "ìµœìƒ", "í”Œë ˆì´ì–´ ìˆ˜": "ì‹±ê¸€/ë©€í‹°", "í‰ì ": 4.7, "ì„¤ëª…": "ê´‘í™œí•œ íŒíƒ€ì§€ ì„¸ê³„ì—ì„œ ê³ ë‚œì´ë„ì˜ ì•¡ì…˜ RPGë¥¼ ê²½í—˜í•˜ì„¸ìš”."},
    "ë¡œìŠ¤íŠ¸ì•„í¬": {"ì¥ë¥´": "MMORPG", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.4, "ì„¤ëª…": "ë°©ëŒ€í•œ ì„¸ê³„ê´€ê³¼ í™”ë ¤í•œ ì•¡ì…˜ì˜ MMORPG."},
    "ë°œë¡œë€íŠ¸": {"ì¥ë¥´": "FPS", "ë‚œì´ë„": "ìƒ", "í”Œë ˆì´ì–´ ìˆ˜": "ë©€í‹°", "í‰ì ": 4.2, "ì„¤ëª…": "ì •êµí•œ ì´ê²©ì „ê³¼ ìš”ì› ìŠ¤í‚¬ì„ í™œìš©í•˜ëŠ” ì „ëµ FPS."},
    "ë””ì•„ë¸”ë¡œ 4": {"ì¥ë¥´": "ì•¡ì…˜ RPG", "ë‚œì´ë„": "ì¤‘", "í”Œë ˆì´ì–´ ìˆ˜": "ì‹±ê¸€/ë©€í‹°", "í‰ì ": 4.0, "ì„¤ëª…": "ì–´ë‘ìš´ íŒíƒ€ì§€ ì„¸ê³„ì—ì„œ ì•…ë§ˆë¥¼ ì‚¬ëƒ¥í•˜ëŠ” í•µì•¤ìŠ¬ë˜ì‹œ RPG."}
}
df_games = pd.DataFrame.from_dict(games, orient='index')
df_games.index.name = 'ê²Œì„ ì´ë¦„'

st.set_page_config(layout="wide", page_title="AI ê¸°ë°˜ ê²Œì„ ì¶”ì²œ (OpenAI)")

st.title("ğŸ® AI ê¸°ë°˜ ê²Œì„ ì¶”ì²œ (OpenAI)")
st.write("ì¢‹ì•„í•˜ëŠ” ê²Œì„ì´ë‚˜ ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì„ ì…ë ¥í•˜ë©´ OpenAIê°€ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤!")

# --- ì‚¬ìš©ì ì…ë ¥ ë°©ì‹ ì„ íƒ ---
recommendation_type = st.radio(
    "ì¶”ì²œ ë°©ì‹ ì„ íƒ:",
    ("ì„ í˜¸ ê²Œì„ ì„ íƒ", "ììœ ë¡œìš´ í…ìŠ¤íŠ¸ ì„¤ëª…"),
    index=0
)

recommended_games = ""

# --- ìºì‹œëœ ì¶”ì²œ í•¨ìˆ˜ ---
@st.cache_data(show_spinner=False)
def get_recommendation(prompt_text):
    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",  # RateLimit ë‚®ê³  ì•ˆì •ì 
            messages=[
                {"role": "system", "content": "ë„ˆëŠ” ìœ ëŠ¥í•œ ê²Œì„ íë ˆì´í„°ì•¼."},
                {"role": "user", "content": prompt_text}
            ],
            max_tokens=500
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"âš ï¸ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}"

# --- ì¶”ì²œ ì²˜ë¦¬ ---
if recommendation_type == "ì„ í˜¸ ê²Œì„ ì„ íƒ":
    selected_game = st.selectbox(
        "ì¢‹ì•„í•˜ëŠ” ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”:",
        ['--ì„ íƒ--', *sorted(df_games.index.tolist())],
        key="game_select"
    )
    if selected_game != '--ì„ íƒ--':
        st.info(f"'{selected_game}'ì™€ ë¹„ìŠ·í•œ ê²Œì„ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”!")
        if st.button("AI ì¶”ì²œë°›ê¸° (ì„ í˜¸ ê²Œì„)"):
            prompt = f"'{selected_game}'ì™€ ë¹„ìŠ·í•œ ê²Œì„ 3ê°œë¥¼ ì¶”ì²œí•´ì¤˜. ì´ë¦„, ì¥ë¥´, 1~2ë¬¸ì¥ ì„¤ëª…ì„ í•œêµ­ì–´ë¡œ."
            with st.spinner("ì¶”ì²œ ì¤‘..."):
                recommended_games = get_recommendation(prompt)
            st.subheader("ğŸ’¡ OpenAI ì¶”ì²œ ê²°ê³¼")
            st.markdown(recommended_games)

elif recommendation_type == "ììœ ë¡œìš´ í…ìŠ¤íŠ¸ ì„¤ëª…":
    user_desc = st.text_area(
        "ì›í•˜ëŠ” ê²Œì„ ìŠ¤íƒ€ì¼ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”:",
        height=100,
        key="text_input"
    )
    if st.button("AI ì¶”ì²œë°›ê¸° (í…ìŠ¤íŠ¸ ì„¤ëª…)"):
        if user_desc.strip():
            st.info(f"'{user_desc}' ìŠ¤íƒ€ì¼ì— ë§ëŠ” ê²Œì„ì„ ì¶”ì²œí•©ë‹ˆë‹¤!")
            prompt = f"'{user_desc}' ìŠ¤íƒ€ì¼ì˜ ê²Œì„ 3ê°œë¥¼ ì¶”ì²œí•´ì¤˜. ì´ë¦„, ì¥ë¥´, 1~2ë¬¸ì¥ ì„¤ëª…ì„ í•œêµ­ì–´ë¡œ."
            with st.spinner("ì¶”ì²œ ì¤‘..."):
                recommended_games = get_recommendation(prompt)
            st.subheader("ğŸ’¡ OpenAI ì¶”ì²œ ê²°ê³¼")
            st.markdown(recommended_games)
        else:
            st.warning("ê²Œì„ ìŠ¤íƒ€ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!")
